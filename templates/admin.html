<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡¤å‡°å°ç°é‡‘ç®¡ç†ç³»ç»Ÿ - åå°ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"> 
    <style>
        :root {
            --primary-color: #4361ee;
            --income-color: #4cc9f0;
            --expense-color: #f72585;
            --sidebar-bg: linear-gradient(135deg, #2b5876 0%, #4e4376 100%);
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        /* ä¾§è¾¹æ ä¼˜åŒ– */
        .sidebar {
            background: var(--sidebar-bg);
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .sidebar-header {
            text-align: center;
            padding: 30px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-header h4 {
            color: white;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .sidebar-header .badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .nav-link {
            color: rgba(255,255,255,.8);
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .nav-link:hover {
            color: white;
            background-color: rgba(255,255,255,.15);
            transform: translateX(5px);
        }
        
        .nav-link.active {
            background-color: rgba(255,255,255,.2);
            color: white;
        }
        
        .nav-link i {
            width: 25px;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                transition: left 0.3s;
                z-index: 1050;
            }
            
            .sidebar.show {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
                padding: 10px;
            }
            
            .stats-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .top-bar h1 {
                font-size: 1.3rem;
            }
            
            .top-bar .btn-group {
                position: static;
            }
            
            /* ç­›é€‰å™¨å“åº”å¼ */
            .row.g-3 > div {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            /* è¡¨æ ¼å“åº”å¼ */
            .table-responsive {
                font-size: 0.85rem;
            }
            
            .transaction-row td {
                padding: 8px 4px;
            }
            
            /* åˆ†é¡µå“åº”å¼ */
            #paginationControls {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            #paginationControls .pagination {
                font-size: 0.85rem;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            #paginationControls .pagination .page-link {
                padding: 5px 10px;
                font-size: 0.85rem;
            }
            
            #paginationControls > div {
                width: 100%;
            }
            
            #paginationControls .page-info {
                text-align: center;
                width: 100%;
                font-size: 0.9rem;
            }
            
            #paginationControls .page-size-selector {
                text-align: center;
                width: 100%;
            }
            
            /* æŒ‰é’®ç»„ä¼˜åŒ– */
            .btn-group {
                display: flex;
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .dropdown-menu {
                width: 100%;
            }
        }
        
        /* é¡¶éƒ¨æ  */
        .top-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .top-bar h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        
        .top-bar .update-time {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* æ•°æ®å¡ç‰‡ä¼˜åŒ– */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            padding: 25px;
            border-radius: 12px;
            color: white;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            right: -30px;
            top: -30px;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        
        .stat-card h5 {
            margin: 0 0 10px 0;
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .stat-card h2 {
            margin: 0;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .stat-card i {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 2.5rem;
            opacity: 0.3;
        }
        
        .card-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .card-danger {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        }
        
        .card-info {
            background: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);
        }
        
        /* è¡¨æ ¼ä¼˜åŒ– */
        .custom-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        
        .custom-card-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .custom-card-header h5 {
            margin: 0;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .custom-card-body {
            padding: 20px;
        }
        
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .table {
            margin: 0;
        }
        
        .table thead {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        
        .table thead th {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .transaction-row {
            transition: all 0.2s;
        }
        
        .transaction-row:hover {
            background-color: #f8f9ff;
            transform: scale(1.01);
        }
        
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .badge-income {
            background-color: var(--income-color);
            color: white;
        }
        
        .badge-expense {
            background-color: var(--expense-color);
            color: white;
        }
        
        /* æŒ‰é’®ä¼˜åŒ– */
        .btn-sm {
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .btn-outline-danger:hover {
            transform: scale(1.1);
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        /* å›¾è¡¨å®¹å™¨ */
        #chart-container {
            height: 500px;
            min-height: 450px;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            #chart-container {
                height: 400px;
                min-height: 350px;
            }
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .stats-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* Toast é€šçŸ¥ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
    </style>
</head>
<body>
    <!-- åŠ è½½é®ç½© -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>åŠ è½½æ•°æ®ä¸­...</p>
        </div>
    </div>

    <!-- Toast é€šçŸ¥å®¹å™¨ -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="d-flex">
            <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h4>ğŸ® å‡¤å‡°å°</h4>
                <span class="badge">ç°é‡‘ç®¡ç†ç³»ç»Ÿ</span>
                <p class="text-white-50 small mt-2 mb-0" id="currentTime"></p>
                    </div>
            <ul class="nav flex-column mt-3">
                        <li class="nav-item">
                    <a class="nav-link active" href="#dashboard">
                        <i class="bi bi-speedometer2"></i> æ•°æ®æ¦‚è§ˆ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#transactions">
                        <i class="bi bi-cash-stack"></i> äº¤æ˜“ç®¡ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#reports">
                        <i class="bi bi-graph-up"></i> è´¢åŠ¡æŠ¥è¡¨
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/">
                        <i class="bi bi-house-door"></i> è¿”å›å‰å°
                            </a>
                        </li>
                    </ul>
            </div>
 
            <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content w-100">
            <!-- é¡¶éƒ¨æ  -->
            <div class="top-bar">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1>ğŸ“Š æ•°æ®æ¦‚è§ˆ</h1>
                        <p class="update-time mb-0">
                            <i class="bi bi-clock"></i> æœ€åæ›´æ–°: <span id="updateTime">-</span>
                        </p>
                        </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshData()" title="åˆ·æ–°æ•°æ®">
                            <i class="bi bi-arrow-clockwise"></i> 
                            <span class="d-none d-md-inline">åˆ·æ–°</span>
                        </button>
                        <div class="btn-group">
                            <button class="btn btn-outline-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" title="å¯¼å‡ºæ•°æ®">
                                <i class="bi bi-download"></i> 
                                <span class="d-none d-md-inline">å¯¼å‡º</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="exportToCSV(); return false;">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> CSV (Excel)
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportToJSON(); return false;">
                                    <i class="bi bi-filetype-json"></i> JSON
                                </a></li>
                            </ul>
                        </div>
                        <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
                        <button class="btn btn-outline-secondary btn-sm d-md-none" onclick="toggleSidebar()">
                            <i class="bi bi-list"></i> èœå•
                        </button>
                    </div>
                    </div>
                </div>
 
            <!-- æ•°æ®ç»Ÿè®¡å¡ç‰‡ - ç¬¬ä¸€è¡Œ -->
            <div class="stats-row">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <i class="bi bi-wallet2"></i>
                    <h5>å½“å‰ä½™é¢</h5>
                    <h2 id="currentBalance">Â¥0.00</h2>
                    <small style="color: rgba(255,255,255,0.9);" id="balanceChange"></small>
                            </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                    <i class="bi bi-arrow-up-circle"></i>
                    <h5>æ€»æ”¶å…¥</h5>
                    <h2 id="totalIncome">Â¥0.00</h2>
                    <small style="color: rgba(255,255,255,0.9);" id="incomeCount"></small>
                        </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    <i class="bi bi-arrow-down-circle"></i>
                    <h5>æ€»æ”¯å‡º</h5>
                    <h2 id="totalExpense">Â¥0.00</h2>
                    <small style="color: rgba(255,255,255,0.9);" id="expenseCount"></small>
                    </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                    <i class="bi bi-list-ol"></i>
                    <h5>äº¤æ˜“æ€»æ•°</h5>
                    <h2 id="totalTransactions">0</h2>
                    <small style="color: rgba(255,255,255,0.9);" id="avgTransaction"></small>
                            </div>
                        </div>

            <!-- æ•°æ®ç»Ÿè®¡å¡ç‰‡ - ç¬¬äºŒè¡Œï¼ˆå‘¨æœŸæ•°æ®ï¼‰ -->
            <div class="stats-row">
                <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                    <i class="bi bi-calendar-week"></i>
                    <h5>æœ¬å‘¨æ”¶æ”¯</h5>
                    <h2 id="weekBalance">Â¥0.00</h2>
                    <small style="color: rgba(255,255,255,0.9);" id="weekDetails"></small>
                    </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white;">
                    <i class="bi bi-calendar-month"></i>
                    <h5>æœ¬æœˆæ”¶æ”¯</h5>
                    <h2 id="monthBalance">Â¥0.00</h2>
                    <small style="color: rgba(255,255,255,0.9);" id="monthDetails"></small>
                            </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333;">
                    <i class="bi bi-star"></i>
                    <h5>æœ€é«˜å•ç¬”</h5>
                    <h2 id="maxTransaction">Â¥0.00</h2>
                    <small style="color: rgba(51,51,51,0.8);" id="maxDetails"></small>
                        </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #333;">
                    <i class="bi bi-tags"></i>
                    <h5>çƒ­é—¨åˆ†ç±»</h5>
                    <h2 id="topCategory">-</h2>
                    <small style="color: rgba(51,51,51,0.8);" id="categoryDetails"></small>
                    </div>
                </div>
 
            <!-- é«˜çº§ç­›é€‰å™¨ -->
            <div class="custom-card mb-3">
                <div class="custom-card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label"><i class="bi bi-funnel"></i> å¿«é€Ÿç­›é€‰</label>
                            <select class="form-select" id="periodFilter" onchange="quickFilter()">
                                <option value="all">å…¨éƒ¨è®°å½•</option>
                                <option value="today">ä»Šå¤©</option>
                                <option value="week">æœ€è¿‘7å¤©</option>
                                <option value="month">æœ¬æœˆ</option>
                                <option value="custom">è‡ªå®šä¹‰æ—¥æœŸ</option>
                            </select>
                        </div>
                        <div class="col-md-3" id="customDateRangeGroup" style="display: none;">
                            <label class="form-label"><i class="bi bi-calendar-range"></i> å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" class="form-control" id="startDate">
                    </div>
                        <div class="col-md-3" id="customDateRangeGroup2" style="display: none;">
                            <label class="form-label"><i class="bi bi-calendar-range"></i> ç»“æŸæ—¥æœŸ</label>
                            <input type="date" class="form-control" id="endDate">
                            </div>
                        <div class="col-md-2">
                            <label class="form-label"><i class="bi bi-tag"></i> äº¤æ˜“ç±»å‹</label>
                            <select class="form-select" id="typeFilter">
                                <option value="all">å…¨éƒ¨</option>
                                <option value="income">æ”¶å…¥</option>
                                <option value="expense">æ”¯å‡º</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label"><i class="bi bi-bookmark"></i> åˆ†ç±»</label>
                            <select class="form-select" id="categoryFilter">
                                <option value="all">å…¨éƒ¨åˆ†ç±»</option>
                            </select>
                    </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="applyCustomFilter()">
                                <i class="bi bi-search"></i> æŸ¥è¯¢
                            </button>
                            </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                                <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®
                            </button>
                        </div>
                    </div>
                    
                    <!-- å½“å‰ç­›é€‰çŠ¶æ€æ˜¾ç¤º -->
                    <div id="filterStatus" class="mt-3" style="display: none;">
                        <div class="alert alert-info mb-0 d-flex justify-content-between align-items-center">
                            <span id="filterStatusText"></span>
                            <button class="btn btn-sm btn-outline-info" onclick="resetFilters()">æ¸…é™¤ç­›é€‰</button>
                            </div>
                        </div>
                    </div>
                </div>
 
            <!-- äº¤æ˜“è®°å½• -->
            <div class="custom-card" id="transactions">
                <div class="custom-card-header">
                    <h5><i class="bi bi-table"></i> äº¤æ˜“è®°å½•</h5>
                    <div class="d-flex gap-2 flex-wrap align-items-center">
                        <span class="badge bg-primary" id="filteredCount">0 ç¬”</span>
                        <button class="btn btn-sm btn-outline-success" onclick="exportToCSV()" title="å¯¼å‡ºCSV">
                            <i class="bi bi-file-earmark-spreadsheet"></i> 
                            <span class="d-none d-md-inline">CSV</span>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="exportToJSON()" title="å¯¼å‡ºJSON">
                            <i class="bi bi-filetype-json"></i> 
                            <span class="d-none d-md-inline">JSON</span>
                        </button>
                    </div>
                </div>
                <div class="custom-card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                    <th width="180">æ—¶é—´</th>
                                    <th width="100">ç±»å‹</th>
                                    <th width="120">é‡‘é¢</th>
                                    <th width="100">åˆ†ç±»</th>
                                    <th>å¤‡æ³¨</th>
                                    <th width="80">æ“ä½œ</th>
                                    </tr>
                                </thead>
                            <tbody id="transactionsList">
                                <!-- åŠ¨æ€åŠ è½½ -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- åˆ†é¡µæ§ä»¶ -->
                        <div id="paginationControls" class="d-flex justify-content-between align-items-center mt-3 p-3" style="display: none;">
                            <!-- åˆ†é¡µå†…å®¹å°†ç”±JavaScriptç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
 
            <!-- å›¾è¡¨ç»Ÿè®¡ -->
            <div class="custom-card" id="reports">
                <div class="custom-card-header">
                    <h5><i class="bi bi-graph-up-arrow"></i> åˆ†ç±»æ¶ˆè´¹è¶‹åŠ¿</h5>
                    <div class="text-muted small">
                        <i class="bi bi-info-circle"></i> æŒ‰æ—¶é—´æ˜¾ç¤ºå„åˆ†ç±»æ¶ˆè´¹è¶‹åŠ¿ï¼ˆå‰8ä¸ªåˆ†ç±»ï¼‰| å¯æ‹–åŠ¨ç¼©æ”¾æŸ¥çœ‹è¯¦æƒ…
                    </div>
                    </div>
                <div class="custom-card-body">
                    <div id="chart-container" style="width: 100%; height: 500px;"></div>
                </div>
            </div>
        </div>
    </div>
 
    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">âš ï¸ ç¡®è®¤åˆ é™¤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>ç¡®å®šè¦åˆ é™¤è¿™æ¡äº¤æ˜“è®°å½•å—ï¼Ÿæ­¤æ“ä½œ<strong>ä¸å¯æ’¤é”€</strong>ã€‚</p>
                    <div id="deleteDetails" class="alert alert-info"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">ç¡®è®¤åˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>
 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script> 
    <script>
        let allTransactions = [];
        let currentBalance = 0;
        let myChart = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            loadData();
        });
        
        // æ›´æ–°å½“å‰æ—¶é—´
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeStr;
        }
        
        // æ˜¾ç¤º Toast é€šçŸ¥
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show`;
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // è¯·æ±‚æ‰€æœ‰æ•°æ®ï¼ˆä¸é™åˆ¶æ•°é‡ï¼‰
                const response = await fetch('/api/transactions?limit=10000');
                const data = await response.json();
                
                if (data.success) {
                    allTransactions = data.transactions || [];
                    currentBalance = data.balance || 0;
                    
                    updateDashboard();
                    renderTransactions(allTransactions);
                    initChart(allTransactions);
                    
                    // æ›´æ–°æ—¶é—´
                    const now = new Date();
                    document.getElementById('updateTime').textContent = now.toLocaleTimeString('zh-CN');
                } else {
                    throw new Error(data.message || 'æ•°æ®åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showToast('æ•°æ®åŠ è½½å¤±è´¥: ' + error.message, 'danger');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }
        
        // æ›´æ–°ä»ªè¡¨æ¿
        function updateDashboard() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // è®¡ç®—æ€»æ”¶å…¥å’Œæ€»æ”¯å‡º
            const totalIncome = allTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const totalExpense = allTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const incomeCount = allTransactions.filter(t => t.type === 'income').length;
            const expenseCount = allTransactions.filter(t => t.type === 'expense').length;
            
            // ç¬¬ä¸€è¡Œæ•°æ®å¡ç‰‡
            document.getElementById('currentBalance').textContent = `Â¥${currentBalance.toFixed(2)}`;
            document.getElementById('balanceChange').textContent = `æ”¶å…¥-æ”¯å‡º = Â¥${(totalIncome - totalExpense).toFixed(2)}`;
            
            document.getElementById('totalIncome').textContent = `Â¥${totalIncome.toFixed(2)}`;
            document.getElementById('incomeCount').textContent = `${incomeCount} ç¬”æ”¶å…¥`;
            
            document.getElementById('totalExpense').textContent = `Â¥${totalExpense.toFixed(2)}`;
            document.getElementById('expenseCount').textContent = `${expenseCount} ç¬”æ”¯å‡º`;
            
            document.getElementById('totalTransactions').textContent = allTransactions.length;
            const avgAmount = allTransactions.length > 0 ? (totalIncome + totalExpense) / allTransactions.length : 0;
            document.getElementById('avgTransaction').textContent = `å¹³å‡ Â¥${avgAmount.toFixed(2)}`;
            
            // æœ¬å‘¨æ•°æ®
            const monday = new Date(today);
            const dayOfWeek = today.getDay();
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            const weekTransactions = allTransactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate >= monday && tDate <= sunday;
            });
            
            const weekIncome = weekTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const weekExpense = weekTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            document.getElementById('weekBalance').textContent = `Â¥${(weekIncome - weekExpense).toFixed(2)}`;
            document.getElementById('weekDetails').textContent = `æ”¶å…¥Â¥${weekIncome.toFixed(0)} / æ”¯å‡ºÂ¥${weekExpense.toFixed(0)}`;
            
            // æœ¬æœˆæ•°æ®
            const monthStr = today.toISOString().substring(0, 7);
            const monthTransactions = allTransactions.filter(t => t.date && t.date.startsWith(monthStr));
            
            const monthIncome = monthTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const monthExpense = monthTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            document.getElementById('monthBalance').textContent = `Â¥${(monthIncome - monthExpense).toFixed(2)}`;
            document.getElementById('monthDetails').textContent = `æ”¶å…¥Â¥${monthIncome.toFixed(0)} / æ”¯å‡ºÂ¥${monthExpense.toFixed(0)}`;
            
            // æœ€é«˜å•ç¬”äº¤æ˜“
            let maxTransaction = 0;
            let maxType = '';
            let maxCategory = '';
            allTransactions.forEach(t => {
                const amount = parseFloat(t.amount || 0);
                if (amount > maxTransaction) {
                    maxTransaction = amount;
                    maxType = t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º';
                    maxCategory = t.category || 'æœªåˆ†ç±»';
                }
            });
            
            document.getElementById('maxTransaction').textContent = `Â¥${maxTransaction.toFixed(2)}`;
            document.getElementById('maxDetails').textContent = maxTransaction > 0 ? `${maxType} Â· ${maxCategory}` : '-';
            
            // çƒ­é—¨åˆ†ç±»
            const categoryStats = {};
            allTransactions.forEach(t => {
                const cat = t.category || 'æœªåˆ†ç±»';
                if (!categoryStats[cat]) {
                    categoryStats[cat] = { count: 0, total: 0 };
                }
                categoryStats[cat].count++;
                categoryStats[cat].total += parseFloat(t.amount || 0);
            });
            
            const sortedCategories = Object.keys(categoryStats).sort((a, b) => 
                categoryStats[b].total - categoryStats[a].total
            );
            
            if (sortedCategories.length > 0) {
                const topCat = sortedCategories[0];
                document.getElementById('topCategory').textContent = topCat;
                document.getElementById('categoryDetails').textContent = 
                    `${categoryStats[topCat].count}ç¬” Â· Â¥${categoryStats[topCat].total.toFixed(0)}`;
            } else {
                document.getElementById('topCategory').textContent = '-';
                document.getElementById('categoryDetails').textContent = '-';
            }
            
            // å¡«å……åˆ†ç±»ä¸‹æ‹‰æ¡†
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="all">å…¨éƒ¨åˆ†ç±»</option>';
            sortedCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = `${cat} (${categoryStats[cat].count})`;
                categoryFilter.appendChild(option);
                });
        }
 
        // åˆ†é¡µé…ç½®
        let currentPage = 1;
        let pageSize = 20;
        let currentFilteredTransactions = [];
        
        // æ¸²æŸ“äº¤æ˜“åˆ—è¡¨ï¼ˆå¸¦åˆ†é¡µï¼‰
        function renderTransactions(transactions) {
            currentFilteredTransactions = transactions || [];
            const tbody = document.getElementById('transactionsList');
            
            if (currentFilteredTransactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-5">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <p class="mt-2">æš‚æ— äº¤æ˜“è®°å½•</p>
                        </td>
                    </tr>
                `;
                document.getElementById('paginationControls').style.display = 'none';
                updateFilteredCount();
                return;
            }
            
            // è®¡ç®—åˆ†é¡µ
            const totalPages = Math.ceil(currentFilteredTransactions.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, currentFilteredTransactions.length);
            const pageTransactions = currentFilteredTransactions.slice(startIndex, endIndex);
            
            // æ¸²æŸ“å½“å‰é¡µæ•°æ®
            tbody.innerHTML = pageTransactions.map(t => `
                    <tr class="transaction-row">
                        <td>${new Date(t.time).toLocaleString('zh-CN')}</td>
                        <td>
                            <span class="badge ${t.type === 'income' ? 'badge-income' : 'badge-expense'}">
                                ${t.type === 'income' ? 'ğŸ’° æ”¶å…¥' : 'ğŸ’¸ æ”¯å‡º'}
                        </span>
                    </td>
                        <td class="${t.type === 'income' ? 'text-success' : 'text-danger'} fw-bold">
                            ${t.type === 'income' ? '+' : '-'}Â¥${parseFloat(t.amount).toFixed(2)}
                    </td>
                        <td>${t.category || '-'}</td>
                        <td>${t.remark || '-'}</td>
                    <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(${t.id}, '${t.category}', ${t.amount})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
 
            // æ›´æ–°åˆ†é¡µæ§ä»¶
            renderPagination(totalPages, startIndex, endIndex);
            updateFilteredCount();
        }
        
        // æ¸²æŸ“åˆ†é¡µæ§ä»¶
        function renderPagination(totalPages, startIndex, endIndex) {
            const paginationControls = document.getElementById('paginationControls');
            
            if (totalPages <= 1) {
                paginationControls.style.display = 'none';
                return;
            }
            
            paginationControls.style.display = 'flex';
            
            // ç§»åŠ¨ç«¯æ£€æµ‹
            const isMobile = window.innerWidth <= 768;
            const maxVisiblePages = isMobile ? 3 : 5; // ç§»åŠ¨ç«¯åªæ˜¾ç¤º3ä¸ªé¡µç 
            
            let paginationHTML = `
                <div class="page-info text-muted">
                    æ˜¾ç¤º ${startIndex + 1} - ${endIndex} æ¡ï¼Œå…± ${currentFilteredTransactions.length} æ¡
                </div>
                <nav style="width: 100%;">
                    <ul class="pagination mb-0 justify-content-center">
            `;
            
            // ä¸Šä¸€é¡µ
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                        ${isMobile ? 'â€¹' : 'ä¸Šä¸€é¡µ'}
                    </a>
                </li>
            `;
            
            // é¡µç 
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // ç¬¬ä¸€é¡µ
            if (startPage > 1) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(1); return false;">1</a></li>`;
                if (startPage > 2) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            // ä¸­é—´é¡µç 
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>
                `;
            }
            
            // æœ€åä¸€é¡µ
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a></li>`;
            }
            
            // ä¸‹ä¸€é¡µ
            paginationHTML += `
                <li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                        ${isMobile ? 'â€º' : 'ä¸‹ä¸€é¡µ'}
                    </a>
                </li>
            `;
            
            paginationHTML += `
                    </ul>
                </nav>
                <div class="page-size-selector">
                    <select class="form-select form-select-sm d-inline-block" style="width: auto;" onchange="changePageSize(this.value)">
                        <option value="10" ${pageSize === 10 ? 'selected' : ''}>10æ¡/é¡µ</option>
                        <option value="20" ${pageSize === 20 ? 'selected' : ''}>20æ¡/é¡µ</option>
                        <option value="50" ${pageSize === 50 ? 'selected' : ''}>50æ¡/é¡µ</option>
                        <option value="100" ${pageSize === 100 ? 'selected' : ''}>100æ¡/é¡µ</option>
                    </select>
                </div>
            `;
            
            paginationControls.innerHTML = paginationHTML;
        }
        
        // åˆ‡æ¢é¡µç 
        function changePage(page) {
            const totalPages = Math.ceil(currentFilteredTransactions.length / pageSize);
            
            // ä¸¥æ ¼è¾¹ç•Œæ£€æŸ¥
            if (page < 1 || page > totalPages || isNaN(page)) {
                console.warn('æ— æ•ˆçš„é¡µç :', page);
                return;
            }
            
            // ç¡®ä¿ä¸ä¼šæº¢å‡º
            currentPage = Math.max(1, Math.min(page, totalPages));
            
            renderTransactions(currentFilteredTransactions);
            
            // æ»šåŠ¨åˆ°è¡¨æ ¼é¡¶éƒ¨
            try {
                document.getElementById('transactions').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (e) {
                console.warn('æ»šåŠ¨å¤±è´¥:', e);
            }
        }
        
        // åˆ‡æ¢æ¯é¡µæ˜¾ç¤ºæ•°é‡
        function changePageSize(newSize) {
            pageSize = parseInt(newSize);
            currentPage = 1;
            renderTransactions(currentFilteredTransactions);
        }
        
        // æ›´æ–°ç­›é€‰è®¡æ•°
        function updateFilteredCount() {
            const count = currentFilteredTransactions.length;
            document.getElementById('filteredCount').textContent = `${count} ç¬”`;
            
            // è®¡ç®—ç­›é€‰åçš„ç»Ÿè®¡
            const income = currentFilteredTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const expense = currentFilteredTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            // æ›´æ–°ç­›é€‰çŠ¶æ€ä¸­çš„ç»Ÿè®¡ä¿¡æ¯
            const filterStatus = document.getElementById('filterStatus');
            if (filterStatus.style.display !== 'none') {
                const filterStatusText = document.getElementById('filterStatusText');
                const currentText = filterStatusText.textContent || filterStatusText.innerHTML;
                const parts = currentText.split('|');
                if (parts.length > 0) {
                    filterStatusText.innerHTML = `${parts[0]} | å…± <strong>${count}</strong> ç¬”äº¤æ˜“ | æ”¶å…¥ <strong class="text-success">Â¥${income.toFixed(2)}</strong> | æ”¯å‡º <strong class="text-danger">Â¥${expense.toFixed(2)}</strong>`;
                }
            }
        }
        
        // å¿«é€Ÿç­›é€‰
        function quickFilter() {
            const period = document.getElementById('periodFilter').value;
            
            if (period === 'custom') {
                // æ˜¾ç¤ºè‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨
                document.getElementById('customDateRangeGroup').style.display = 'block';
                document.getElementById('customDateRangeGroup2').style.display = 'block';
                
                // è®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆæœ€è¿‘30å¤©ï¼‰
                const today = new Date();
                const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                document.getElementById('startDate').value = monthAgo.toISOString().split('T')[0];
                document.getElementById('endDate').value = today.toISOString().split('T')[0];
            } else {
                // éšè—è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨
                document.getElementById('customDateRangeGroup').style.display = 'none';
                document.getElementById('customDateRangeGroup2').style.display = 'none';
                
                // åº”ç”¨å¿«é€Ÿç­›é€‰
                applyCustomFilter();
            }
        }
        
        // åº”ç”¨è‡ªå®šä¹‰ç­›é€‰
        function applyCustomFilter() {
            const period = document.getElementById('periodFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            let filtered = [...allTransactions];
            let filterDesc = [];
            
            // æ—¶é—´ç­›é€‰
            const now = new Date();
            switch(period) {
                case 'today':
                    const today = now.toISOString().split('T')[0];
                    filtered = filtered.filter(t => t.date === today);
                    filterDesc.push('ä»Šå¤©');
                    break;
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    filtered = filtered.filter(t => new Date(t.date) >= weekAgo);
                    filterDesc.push('æœ€è¿‘7å¤©');
                    break;
                case 'month':
                    const monthStr = now.toISOString().substring(0, 7);
                    filtered = filtered.filter(t => t.date && t.date.startsWith(monthStr));
                    filterDesc.push('æœ¬æœˆ');
                    break;
                case 'custom':
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    
                    if (startDate && endDate) {
                        filtered = filtered.filter(t => {
                            if (!t.date) return false;
                            return t.date >= startDate && t.date <= endDate;
                        });
                        filterDesc.push(`${startDate} ~ ${endDate}`);
                    }
                    break;
            }
            
            // ç±»å‹ç­›é€‰
            if (typeFilter !== 'all') {
                filtered = filtered.filter(t => t.type === typeFilter);
                filterDesc.push(typeFilter === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º');
            }
            
            // åˆ†ç±»ç­›é€‰
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(t => t.category === categoryFilter);
                filterDesc.push(categoryFilter);
            }
            
            // æ›´æ–°ç­›é€‰çŠ¶æ€æ˜¾ç¤º
            const filterStatus = document.getElementById('filterStatus');
            const filterStatusText = document.getElementById('filterStatusText');
            
            if (filterDesc.length > 0) {
                filterStatus.style.display = 'block';
                filterStatusText.innerHTML = `<i class="bi bi-funnel-fill"></i> å½“å‰ç­›é€‰: ${filterDesc.join(' Â· ')} | å…± <strong>${filtered.length}</strong> ç¬”äº¤æ˜“`;
            } else {
                filterStatus.style.display = 'none';
            }
            
            // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            currentPage = 1;
            
            // æ¸²æŸ“äº¤æ˜“åˆ—è¡¨å’Œå›¾è¡¨
            renderTransactions(filtered);
            
            // é‡æ–°åˆå§‹åŒ–å›¾è¡¨ï¼ˆç¡®ä¿å›¾è¡¨æ›´æ–°ï¼‰
            if (myChart) {
                myChart.dispose();
                myChart = null;
            }
            initChart(filtered);
            
            console.log('ç­›é€‰å®Œæˆï¼Œå…±', filtered.length, 'ç¬”äº¤æ˜“');
        }
        
        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.getElementById('periodFilter').value = 'all';
            document.getElementById('typeFilter').value = 'all';
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('customDateRangeGroup').style.display = 'none';
            document.getElementById('customDateRangeGroup2').style.display = 'none';
            document.getElementById('filterStatus').style.display = 'none';
            
            currentPage = 1;
            renderTransactions(allTransactions);
            
            // é‡æ–°åˆå§‹åŒ–å›¾è¡¨
            if (myChart) {
                myChart.dispose();
                myChart = null;
            }
            initChart(allTransactions);
            
            console.log('ç­›é€‰å·²é‡ç½®');
        }
        
        // å¯¼å‡ºä¸ºCSV
        function exportToCSV() {
            const period = document.getElementById('periodFilter').value;
            let transactions = getFilteredTransactions();
            
            if (transactions.length === 0) {
                showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'warning');
                return;
            }
            
            // åˆ›å»ºCSVå†…å®¹
            let csv = '\uFEFF'; // UTF-8 BOM for Excel
            csv += 'æ—¥æœŸ,ç±»å‹,åˆ†ç±»,é‡‘é¢,å¤‡æ³¨\n';
            
            transactions.forEach(t => {
                const type = t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º';
                const amount = parseFloat(t.amount || 0).toFixed(2);
                const remark = (t.remark || '').replace(/,/g, 'ï¼Œ'); // æ›¿æ¢é€—å·é¿å…CSVé”™è¯¯
                csv += `${t.date},${type},${t.category},${amount},${remark}\n`;
            });
            
            // ä¸‹è½½
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `äº¤æ˜“è®°å½•_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast(`å·²å¯¼å‡º ${transactions.length} ç¬”äº¤æ˜“è®°å½•`, 'success');
        }
        
        // å¯¼å‡ºä¸ºJSON
        function exportToJSON() {
            let transactions = getFilteredTransactions();
            
            if (transactions.length === 0) {
                showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'warning');
                return;
            }
            
            const data = {
                export_time: new Date().toISOString(),
                total_count: transactions.length,
                transactions: transactions
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `äº¤æ˜“è®°å½•_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast(`å·²å¯¼å‡º ${transactions.length} ç¬”äº¤æ˜“è®°å½•`, 'success');
        }
        
        // è·å–å½“å‰ç­›é€‰çš„äº¤æ˜“åˆ—è¡¨
        function getFilteredTransactions() {
            const period = document.getElementById('periodFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            let filtered = [...allTransactions];
            
            // æ—¶é—´ç­›é€‰
            const now = new Date();
            switch(period) {
                case 'today':
                    const today = now.toISOString().split('T')[0];
                    filtered = filtered.filter(t => t.date === today);
                    break;
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    filtered = filtered.filter(t => new Date(t.date) >= weekAgo);
                    break;
                case 'month':
                    const monthStr = now.toISOString().substring(0, 7);
                    filtered = filtered.filter(t => t.date && t.date.startsWith(monthStr));
                    break;
                case 'custom':
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    if (startDate && endDate) {
                        filtered = filtered.filter(t => t.date && t.date >= startDate && t.date <= endDate);
                    }
                    break;
            }
            
            if (typeFilter !== 'all') {
                filtered = filtered.filter(t => t.type === typeFilter);
            }
            
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(t => t.category === categoryFilter);
            }
            
            return filtered;
        }
            
        // åˆå§‹åŒ–å›¾è¡¨ï¼ˆè¶‹åŠ¿çº¿å›¾ï¼‰
        function initChart(transactions) {
            if (!myChart) {
                const chartDom = document.getElementById('chart-container');
                if (!chartDom) return;
                myChart = echarts.init(chartDom);
            }
            
            // æ•°æ®éªŒè¯å’Œæ¸…ç†
            const validTransactions = transactions.filter(t => 
                t && t.category && t.amount && t.date && t.type
            );
            
            if (validTransactions.length === 0) {
            const option = {
                    title: {
                        text: 'æš‚æ— æ•°æ®',
                        left: 'center',
                        top: 'center',
                        textStyle: {
                            color: '#999',
                            fontSize: 16
                        }
                    }
                };
                myChart.setOption(option);
                return;
            }
            
            // æŒ‰æ—¥æœŸå’Œåˆ†ç±»ç»Ÿè®¡
            const dateMap = {};
            const categories = new Set();
            
            validTransactions.forEach(t => {
                const date = t.date;
                const category = t.category || 'æœªåˆ†ç±»';
                const amount = parseFloat(t.amount) || 0;
                
                categories.add(category);
                
                if (!dateMap[date]) {
                    dateMap[date] = {};
                }
                if (!dateMap[date][category]) {
                    dateMap[date][category] = 0;
                }
                
                // ç´¯åŠ é‡‘é¢ï¼ˆæ”¶å…¥ä¸ºæ­£ï¼Œæ”¯å‡ºä¹Ÿä¸ºæ­£ï¼Œç»Ÿä¸€æ˜¾ç¤ºï¼‰
                dateMap[date][category] += amount;
            });
            
            // è·å–æ’åºåçš„æ—¥æœŸåˆ—è¡¨
            const dates = Object.keys(dateMap).sort();
            
            // æŒ‰æ€»é‡‘é¢æ’åºåˆ†ç±»ï¼Œå–å‰8ä¸ª
            const categoriesList = Array.from(categories);
            const categoryTotals = {};
            categoriesList.forEach(cat => {
                categoryTotals[cat] = validTransactions
                    .filter(t => t.category === cat)
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            });
            
            const topCategories = categoriesList
                .sort((a, b) => categoryTotals[b] - categoryTotals[a])
                .slice(0, 8); // åªæ˜¾ç¤ºå‰8ä¸ªåˆ†ç±»
            
            // å‡†å¤‡ç³»åˆ—æ•°æ®
            const series = topCategories.map((category, index) => {
                const data = dates.map(date => {
                    return dateMap[date][category] || 0;
                });
                
                // é¢œè‰²æ–¹æ¡ˆ
                const colors = [
                    '#4cc9f0', '#f72585', '#4361ee', '#3a0ca3',
                    '#7209b7', '#f77f00', '#06d6a0', '#ef476f'
                ];
                
                return {
                    name: category,
                    type: 'line',
                    data: data,
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 6,
                    itemStyle: {
                        color: colors[index % colors.length]
                    },
                    lineStyle: {
                        width: 2
                    },
                    areaStyle: {
                        opacity: 0.1
                    }
                };
            });
            
            const option = {
                title: {
                    text: 'åˆ†ç±»æ¶ˆè´¹è¶‹åŠ¿',
                    subtext: `${validTransactions.length}ç¬”äº¤æ˜“ | ${dates.length}å¤© | å‰${topCategories.length}ä¸ªåˆ†ç±»`,
                    left: 'center',
                    textStyle: {
                        fontSize: 18,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        label: {
                            backgroundColor: '#6a7985'
                        }
                    },
                    formatter: function(params) {
                        let result = `<strong>${params[0].axisValue}</strong><br>`;
                        let total = 0;
                        
                        params.forEach(p => {
                            if (p.value > 0) {
                                result += `${p.marker} ${p.seriesName}: Â¥${p.value.toFixed(2)}<br>`;
                                total += p.value;
                            }
                        });
                        
                        if (params.length > 1) {
                            result += `<strong>å½“æ—¥åˆè®¡: Â¥${total.toFixed(2)}</strong>`;
                        }
                        return result;
                    }
                },
                legend: {
                    data: topCategories,
                    bottom: 5,
                    type: 'scroll',
                    pageButtonItemGap: 5,
                    pageIconSize: 12
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '12%',
                    top: '18%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dates,
                    axisLabel: {
                        rotate: dates.length > 15 ? 45 : 0,
                        interval: Math.max(0, Math.floor(dates.length / 10)),
                        formatter: function(value) {
                            // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                            if (value.length === 10) {
                                return value.substring(5); // æ˜¾ç¤º MM-DD
                            }
                            return value;
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'é‡‘é¢ï¼ˆÂ¥ï¼‰',
                    axisLabel: {
                        formatter: function(value) {
                            if (value >= 10000) {
                                return (value / 10000).toFixed(1) + 'ä¸‡';
                            }
                            return value.toFixed(0);
                        }
                    }
                },
                series: series,
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        start: 0,
                        end: 100,
                        height: 20,
                        bottom: 40
                    }
                ]
            };
            
            myChart.setOption(option, true);
            
            // å“åº”çª—å£å¤§å°å˜åŒ–
            if (window.chartResizeHandler) {
                window.removeEventListener('resize', window.chartResizeHandler);
            }
            window.chartResizeHandler = () => myChart.resize();
            window.addEventListener('resize', window.chartResizeHandler);
            
            console.log('âœ… å›¾è¡¨å·²æ›´æ–°ï¼š', topCategories.length, 'ä¸ªåˆ†ç±»ï¼Œ', dates.length, 'å¤©');
        }
        
        // ç¡®è®¤åˆ é™¤
        let deleteId = null;
        function confirmDelete(id, category, amount) {
            deleteId = id;
            document.getElementById('deleteDetails').innerHTML = `
                <strong>åˆ†ç±»:</strong> ${category}<br>
                <strong>é‡‘é¢:</strong> Â¥${parseFloat(amount).toFixed(2)}
            `;
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }
        
        // æ‰§è¡Œåˆ é™¤
        document.getElementById('confirmDelete').addEventListener('click', async function() {
            if (!deleteId) return;
            
            try {
                const response = await fetch(`/api/transactions/${deleteId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                    loadData();
                } else {
                    showToast(data.message || 'åˆ é™¤å¤±è´¥', 'danger');
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'danger');
            }
        });
        
        // åˆ·æ–°æ•°æ®
        function refreshData() {
            showToast('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'info');
            loadData();
        }
        
        // åˆ‡æ¢ä¾§è¾¹æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('show');
        }
        
        // ç‚¹å‡»ä¸»å†…å®¹åŒºå…³é—­ä¾§è¾¹æ 
        document.addEventListener('DOMContentLoaded', function() {
            const mainContent = document.querySelector('.main-content');
            const sidebar = document.querySelector('.sidebar');
            
            if (mainContent && sidebar) {
                mainContent.addEventListener('click', function() {
                    if (window.innerWidth <= 768 && sidebar.classList.contains('show')) {
                        sidebar.classList.remove('show');
                    }
                });
            }
        });
    </script>
</body>
</html>
