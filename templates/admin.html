<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>凤凰台现金管理系统 - 后台管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"> 
    <style>
        :root {
            --primary-color: #4361ee;
            --income-color: #4cc9f0;
            --expense-color: #f72585;
            --sidebar-bg: linear-gradient(135deg, #2b5876 0%, #4e4376 100%);
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        /* 侧边栏优化 */
        .sidebar {
            background: var(--sidebar-bg);
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .sidebar-header {
            text-align: center;
            padding: 30px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-header h4 {
            color: white;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .sidebar-header .badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .nav-link {
            color: rgba(255,255,255,.8);
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .nav-link:hover {
            color: white;
            background-color: rgba(255,255,255,.15);
            transform: translateX(5px);
        }
        
        .nav-link.active {
            background-color: rgba(255,255,255,.2);
            color: white;
        }
        
        .nav-link i {
            width: 25px;
        }
        
        /* 主内容区 */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                transition: left 0.3s;
                z-index: 1050;
            }
            
            .sidebar.show {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
                padding: 10px;
            }
            
            .stats-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .top-bar h1 {
                font-size: 1.3rem;
            }
            
            .top-bar .btn-group {
                position: static;
            }
            
            /* 筛选器响应式 */
            .row.g-3 > div {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            /* 表格响应式 */
            .table-responsive {
                font-size: 0.85rem;
            }
            
            .transaction-row td {
                padding: 8px 4px;
            }
            
            /* 分页响应式 */
            #paginationControls {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            #paginationControls .pagination {
                font-size: 0.85rem;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            #paginationControls .pagination .page-link {
                padding: 5px 10px;
                font-size: 0.85rem;
            }
            
            #paginationControls > div {
                width: 100%;
            }
            
            #paginationControls .page-info {
                text-align: center;
                width: 100%;
                font-size: 0.9rem;
            }
            
            #paginationControls .page-size-selector {
                text-align: center;
                width: 100%;
            }
            
            /* 按钮组优化 */
            .btn-group {
                display: flex;
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .dropdown-menu {
                width: 100%;
            }
        }
        
        /* 顶部栏 */
        .top-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .top-bar h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        
        .top-bar .update-time {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* 数据卡片优化 */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            padding: 25px;
            border-radius: 12px;
            color: white;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            right: -30px;
            top: -30px;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        
        .stat-card h5 {
            margin: 0 0 10px 0;
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .stat-card h2 {
            margin: 0;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .stat-card i {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 2.5rem;
            opacity: 0.3;
        }
        
        .card-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .card-danger {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        }
        
        .card-info {
            background: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);
        }
        
        /* 表格优化 */
        .custom-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        
        .custom-card-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .custom-card-header h5 {
            margin: 0;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .custom-card-body {
            padding: 20px;
        }
        
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .table {
            margin: 0;
        }
        
        .table thead {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        
        .table thead th {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .transaction-row {
            transition: all 0.2s;
        }
        
        .transaction-row:hover {
            background-color: #f8f9ff;
            transform: scale(1.01);
        }
        
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .badge-income {
            background-color: var(--income-color);
            color: white;
        }
        
        .badge-expense {
            background-color: var(--expense-color);
            color: white;
        }
        
        /* 按钮优化 */
        .btn-sm {
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .btn-outline-danger:hover {
            transform: scale(1.1);
        }
        
        /* 加载状态 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        /* 图表容器 */
        #chart-container {
            height: 500px;
            min-height: 450px;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            #chart-container {
                height: 400px;
                min-height: 350px;
            }
        }
        
        /* 响应式 */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .stats-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* Toast 通知 */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
    </style>
</head>
<body>
    <!-- 加载遮罩 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>加载数据中...</p>
        </div>
    </div>

    <!-- Toast 通知容器 -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="d-flex">
            <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h4>🏮 凤凰台</h4>
                <span class="badge">现金管理系统</span>
                <p class="text-white-50 small mt-2 mb-0" id="currentTime"></p>
                    </div>
            <ul class="nav flex-column mt-3">
                        <li class="nav-item">
                    <a class="nav-link active" href="#dashboard">
                        <i class="bi bi-speedometer2"></i> 数据概览
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#transactions">
                        <i class="bi bi-cash-stack"></i> 交易管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#reports">
                        <i class="bi bi-graph-up"></i> 财务报表
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/">
                        <i class="bi bi-house-door"></i> 返回前台
                            </a>
                        </li>
                    </ul>
            </div>
 
            <!-- 主内容区 -->
        <div class="main-content w-100">
            <!-- 顶部栏 -->
            <div class="top-bar">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1>📊 数据概览</h1>
                        <p class="update-time mb-0">
                            <i class="bi bi-clock"></i> 最后更新: <span id="updateTime">-</span>
                        </p>
                        </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshData()" title="刷新数据">
                            <i class="bi bi-arrow-clockwise"></i> 
                            <span class="d-none d-md-inline">刷新</span>
                        </button>
                        <div class="btn-group">
                            <button class="btn btn-outline-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" title="导出数据">
                                <i class="bi bi-download"></i> 
                                <span class="d-none d-md-inline">导出</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="exportToCSV(); return false;">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> CSV (Excel)
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportToJSON(); return false;">
                                    <i class="bi bi-filetype-json"></i> JSON
                                </a></li>
                            </ul>
                        </div>
                        <!-- 移动端菜单按钮 -->
                        <button class="btn btn-outline-secondary btn-sm d-md-none" onclick="toggleSidebar()">
                            <i class="bi bi-list"></i> 菜单
                        </button>
                    </div>
                    </div>
                </div>
 
            <!-- 数据统计卡片 - 第一行 -->
            <div class="stats-row">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <i class="bi bi-wallet2"></i>
                    <h5>当前余额</h5>
                    <h2 id="currentBalance">¥0.00</h2>
                    <small style="color: rgba(255,255,255,0.9);" id="balanceChange"></small>
                            </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                    <i class="bi bi-arrow-up-circle"></i>
                    <h5>总收入</h5>
                    <h2 id="totalIncome">¥0.00</h2>
                    <small style="color: rgba(255,255,255,0.9);" id="incomeCount"></small>
                        </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    <i class="bi bi-arrow-down-circle"></i>
                    <h5>总支出</h5>
                    <h2 id="totalExpense">¥0.00</h2>
                    <small style="color: rgba(255,255,255,0.9);" id="expenseCount"></small>
                    </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                    <i class="bi bi-list-ol"></i>
                    <h5>交易总数</h5>
                    <h2 id="totalTransactions">0</h2>
                    <small style="color: rgba(255,255,255,0.9);" id="avgTransaction"></small>
                            </div>
                        </div>

            <!-- 数据统计卡片 - 第二行（周期数据） -->
            <div class="stats-row">
                <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                    <i class="bi bi-calendar-week"></i>
                    <h5>本周收支</h5>
                    <h2 id="weekBalance">¥0.00</h2>
                    <small style="color: rgba(255,255,255,0.9);" id="weekDetails"></small>
                    </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white;">
                    <i class="bi bi-calendar-month"></i>
                    <h5>本月收支</h5>
                    <h2 id="monthBalance">¥0.00</h2>
                    <small style="color: rgba(255,255,255,0.9);" id="monthDetails"></small>
                            </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333;">
                    <i class="bi bi-star"></i>
                    <h5>最高单笔</h5>
                    <h2 id="maxTransaction">¥0.00</h2>
                    <small style="color: rgba(51,51,51,0.8);" id="maxDetails"></small>
                        </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #333;">
                    <i class="bi bi-tags"></i>
                    <h5>热门分类</h5>
                    <h2 id="topCategory">-</h2>
                    <small style="color: rgba(51,51,51,0.8);" id="categoryDetails"></small>
                    </div>
                </div>
 
            <!-- 高级筛选器 -->
            <div class="custom-card mb-3">
                <div class="custom-card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label"><i class="bi bi-funnel"></i> 快速筛选</label>
                            <select class="form-select" id="periodFilter" onchange="quickFilter()">
                                <option value="all">全部记录</option>
                                <option value="today">今天</option>
                                <option value="week">最近7天</option>
                                <option value="month">本月</option>
                                <option value="custom">自定义日期</option>
                            </select>
                        </div>
                        <div class="col-md-3" id="customDateRangeGroup" style="display: none;">
                            <label class="form-label"><i class="bi bi-calendar-range"></i> 开始日期</label>
                            <input type="date" class="form-control" id="startDate">
                    </div>
                        <div class="col-md-3" id="customDateRangeGroup2" style="display: none;">
                            <label class="form-label"><i class="bi bi-calendar-range"></i> 结束日期</label>
                            <input type="date" class="form-control" id="endDate">
                            </div>
                        <div class="col-md-2">
                            <label class="form-label"><i class="bi bi-tag"></i> 交易类型</label>
                            <select class="form-select" id="typeFilter">
                                <option value="all">全部</option>
                                <option value="income">收入</option>
                                <option value="expense">支出</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label"><i class="bi bi-bookmark"></i> 分类</label>
                            <select class="form-select" id="categoryFilter">
                                <option value="all">全部分类</option>
                            </select>
                    </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="applyCustomFilter()">
                                <i class="bi bi-search"></i> 查询
                            </button>
                            </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                                <i class="bi bi-arrow-counterclockwise"></i> 重置
                            </button>
                        </div>
                    </div>
                    
                    <!-- 当前筛选状态显示 -->
                    <div id="filterStatus" class="mt-3" style="display: none;">
                        <div class="alert alert-info mb-0 d-flex justify-content-between align-items-center">
                            <span id="filterStatusText"></span>
                            <button class="btn btn-sm btn-outline-info" onclick="resetFilters()">清除筛选</button>
                            </div>
                        </div>
                    </div>
                </div>
 
            <!-- 交易记录 -->
            <div class="custom-card" id="transactions">
                <div class="custom-card-header">
                    <h5><i class="bi bi-table"></i> 交易记录</h5>
                    <div class="d-flex gap-2 flex-wrap align-items-center">
                        <span class="badge bg-primary" id="filteredCount">0 笔</span>
                        <button class="btn btn-sm btn-outline-success" onclick="exportToCSV()" title="导出CSV">
                            <i class="bi bi-file-earmark-spreadsheet"></i> 
                            <span class="d-none d-md-inline">CSV</span>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="exportToJSON()" title="导出JSON">
                            <i class="bi bi-filetype-json"></i> 
                            <span class="d-none d-md-inline">JSON</span>
                        </button>
                    </div>
                </div>
                <div class="custom-card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                    <th width="180">时间</th>
                                    <th width="100">类型</th>
                                    <th width="120">金额</th>
                                    <th width="100">分类</th>
                                    <th>备注</th>
                                    <th width="80">操作</th>
                                    </tr>
                                </thead>
                            <tbody id="transactionsList">
                                <!-- 动态加载 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 分页控件 -->
                        <div id="paginationControls" class="d-flex justify-content-between align-items-center mt-3 p-3" style="display: none;">
                            <!-- 分页内容将由JavaScript生成 -->
                        </div>
                    </div>
                </div>
 
            <!-- 图表统计 -->
            <div class="custom-card" id="reports">
                <div class="custom-card-header">
                    <h5><i class="bi bi-graph-up-arrow"></i> 分类消费趋势</h5>
                    <div class="text-muted small">
                        <i class="bi bi-info-circle"></i> 按时间显示各分类消费趋势（前8个分类）| 可拖动缩放查看详情
                    </div>
                    </div>
                <div class="custom-card-body">
                    <div id="chart-container" style="width: 100%; height: 500px;"></div>
                </div>
            </div>
        </div>
    </div>
 
    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">⚠️ 确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>确定要删除这条交易记录吗？此操作<strong>不可撤销</strong>。</p>
                    <div id="deleteDetails" class="alert alert-info"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">确认删除</button>
                </div>
            </div>
        </div>
    </div>
 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script> 
    <script>
        let allTransactions = [];
        let currentBalance = 0;
        let myChart = null;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            loadData();
        });
        
        // 更新当前时间
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeStr;
        }
        
        // 显示 Toast 通知
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show`;
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // 加载数据
        async function loadData() {
            try {
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // 请求所有数据（不限制数量）
                const response = await fetch('/api/transactions?limit=10000');
                const data = await response.json();
                
                if (data.success) {
                    allTransactions = data.transactions || [];
                    currentBalance = data.balance || 0;
                    
                    updateDashboard();
                    renderTransactions(allTransactions);
                    initChart(allTransactions);
                    
                    // 更新时间
                    const now = new Date();
                    document.getElementById('updateTime').textContent = now.toLocaleTimeString('zh-CN');
                } else {
                    throw new Error(data.message || '数据加载失败');
                }
            } catch (error) {
                console.error('加载数据失败:', error);
                showToast('数据加载失败: ' + error.message, 'danger');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }
        
        // 更新仪表板
        function updateDashboard() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // 计算总收入和总支出
            const totalIncome = allTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const totalExpense = allTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const incomeCount = allTransactions.filter(t => t.type === 'income').length;
            const expenseCount = allTransactions.filter(t => t.type === 'expense').length;
            
            // 第一行数据卡片
            document.getElementById('currentBalance').textContent = `¥${currentBalance.toFixed(2)}`;
            document.getElementById('balanceChange').textContent = `收入-支出 = ¥${(totalIncome - totalExpense).toFixed(2)}`;
            
            document.getElementById('totalIncome').textContent = `¥${totalIncome.toFixed(2)}`;
            document.getElementById('incomeCount').textContent = `${incomeCount} 笔收入`;
            
            document.getElementById('totalExpense').textContent = `¥${totalExpense.toFixed(2)}`;
            document.getElementById('expenseCount').textContent = `${expenseCount} 笔支出`;
            
            document.getElementById('totalTransactions').textContent = allTransactions.length;
            const avgAmount = allTransactions.length > 0 ? (totalIncome + totalExpense) / allTransactions.length : 0;
            document.getElementById('avgTransaction').textContent = `平均 ¥${avgAmount.toFixed(2)}`;
            
            // 本周数据
            const monday = new Date(today);
            const dayOfWeek = today.getDay();
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            const weekTransactions = allTransactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate >= monday && tDate <= sunday;
            });
            
            const weekIncome = weekTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const weekExpense = weekTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            document.getElementById('weekBalance').textContent = `¥${(weekIncome - weekExpense).toFixed(2)}`;
            document.getElementById('weekDetails').textContent = `收入¥${weekIncome.toFixed(0)} / 支出¥${weekExpense.toFixed(0)}`;
            
            // 本月数据
            const monthStr = today.toISOString().substring(0, 7);
            const monthTransactions = allTransactions.filter(t => t.date && t.date.startsWith(monthStr));
            
            const monthIncome = monthTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const monthExpense = monthTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            document.getElementById('monthBalance').textContent = `¥${(monthIncome - monthExpense).toFixed(2)}`;
            document.getElementById('monthDetails').textContent = `收入¥${monthIncome.toFixed(0)} / 支出¥${monthExpense.toFixed(0)}`;
            
            // 最高单笔交易
            let maxTransaction = 0;
            let maxType = '';
            let maxCategory = '';
            allTransactions.forEach(t => {
                const amount = parseFloat(t.amount || 0);
                if (amount > maxTransaction) {
                    maxTransaction = amount;
                    maxType = t.type === 'income' ? '收入' : '支出';
                    maxCategory = t.category || '未分类';
                }
            });
            
            document.getElementById('maxTransaction').textContent = `¥${maxTransaction.toFixed(2)}`;
            document.getElementById('maxDetails').textContent = maxTransaction > 0 ? `${maxType} · ${maxCategory}` : '-';
            
            // 热门分类
            const categoryStats = {};
            allTransactions.forEach(t => {
                const cat = t.category || '未分类';
                if (!categoryStats[cat]) {
                    categoryStats[cat] = { count: 0, total: 0 };
                }
                categoryStats[cat].count++;
                categoryStats[cat].total += parseFloat(t.amount || 0);
            });
            
            const sortedCategories = Object.keys(categoryStats).sort((a, b) => 
                categoryStats[b].total - categoryStats[a].total
            );
            
            if (sortedCategories.length > 0) {
                const topCat = sortedCategories[0];
                document.getElementById('topCategory').textContent = topCat;
                document.getElementById('categoryDetails').textContent = 
                    `${categoryStats[topCat].count}笔 · ¥${categoryStats[topCat].total.toFixed(0)}`;
            } else {
                document.getElementById('topCategory').textContent = '-';
                document.getElementById('categoryDetails').textContent = '-';
            }
            
            // 填充分类下拉框
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="all">全部分类</option>';
            sortedCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = `${cat} (${categoryStats[cat].count})`;
                categoryFilter.appendChild(option);
                });
        }
 
        // 分页配置
        let currentPage = 1;
        let pageSize = 20;
        let currentFilteredTransactions = [];
        
        // 渲染交易列表（带分页）
        function renderTransactions(transactions) {
            currentFilteredTransactions = transactions || [];
            const tbody = document.getElementById('transactionsList');
            
            if (currentFilteredTransactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-5">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <p class="mt-2">暂无交易记录</p>
                        </td>
                    </tr>
                `;
                document.getElementById('paginationControls').style.display = 'none';
                updateFilteredCount();
                return;
            }
            
            // 计算分页
            const totalPages = Math.ceil(currentFilteredTransactions.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, currentFilteredTransactions.length);
            const pageTransactions = currentFilteredTransactions.slice(startIndex, endIndex);
            
            // 渲染当前页数据
            tbody.innerHTML = pageTransactions.map(t => `
                    <tr class="transaction-row">
                        <td>${new Date(t.time).toLocaleString('zh-CN')}</td>
                        <td>
                            <span class="badge ${t.type === 'income' ? 'badge-income' : 'badge-expense'}">
                                ${t.type === 'income' ? '💰 收入' : '💸 支出'}
                        </span>
                    </td>
                        <td class="${t.type === 'income' ? 'text-success' : 'text-danger'} fw-bold">
                            ${t.type === 'income' ? '+' : '-'}¥${parseFloat(t.amount).toFixed(2)}
                    </td>
                        <td>${t.category || '-'}</td>
                        <td>${t.remark || '-'}</td>
                    <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(${t.id}, '${t.category}', ${t.amount})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
 
            // 更新分页控件
            renderPagination(totalPages, startIndex, endIndex);
            updateFilteredCount();
        }
        
        // 渲染分页控件
        function renderPagination(totalPages, startIndex, endIndex) {
            const paginationControls = document.getElementById('paginationControls');
            
            if (totalPages <= 1) {
                paginationControls.style.display = 'none';
                return;
            }
            
            paginationControls.style.display = 'flex';
            
            // 移动端检测
            const isMobile = window.innerWidth <= 768;
            const maxVisiblePages = isMobile ? 3 : 5; // 移动端只显示3个页码
            
            let paginationHTML = `
                <div class="page-info text-muted">
                    显示 ${startIndex + 1} - ${endIndex} 条，共 ${currentFilteredTransactions.length} 条
                </div>
                <nav style="width: 100%;">
                    <ul class="pagination mb-0 justify-content-center">
            `;
            
            // 上一页
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                        ${isMobile ? '‹' : '上一页'}
                    </a>
                </li>
            `;
            
            // 页码
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // 第一页
            if (startPage > 1) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(1); return false;">1</a></li>`;
                if (startPage > 2) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            // 中间页码
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>
                `;
            }
            
            // 最后一页
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a></li>`;
            }
            
            // 下一页
            paginationHTML += `
                <li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                        ${isMobile ? '›' : '下一页'}
                    </a>
                </li>
            `;
            
            paginationHTML += `
                    </ul>
                </nav>
                <div class="page-size-selector">
                    <select class="form-select form-select-sm d-inline-block" style="width: auto;" onchange="changePageSize(this.value)">
                        <option value="10" ${pageSize === 10 ? 'selected' : ''}>10条/页</option>
                        <option value="20" ${pageSize === 20 ? 'selected' : ''}>20条/页</option>
                        <option value="50" ${pageSize === 50 ? 'selected' : ''}>50条/页</option>
                        <option value="100" ${pageSize === 100 ? 'selected' : ''}>100条/页</option>
                    </select>
                </div>
            `;
            
            paginationControls.innerHTML = paginationHTML;
        }
        
        // 切换页码
        function changePage(page) {
            const totalPages = Math.ceil(currentFilteredTransactions.length / pageSize);
            
            // 严格边界检查
            if (page < 1 || page > totalPages || isNaN(page)) {
                console.warn('无效的页码:', page);
                return;
            }
            
            // 确保不会溢出
            currentPage = Math.max(1, Math.min(page, totalPages));
            
            renderTransactions(currentFilteredTransactions);
            
            // 滚动到表格顶部
            try {
                document.getElementById('transactions').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (e) {
                console.warn('滚动失败:', e);
            }
        }
        
        // 切换每页显示数量
        function changePageSize(newSize) {
            pageSize = parseInt(newSize);
            currentPage = 1;
            renderTransactions(currentFilteredTransactions);
        }
        
        // 更新筛选计数
        function updateFilteredCount() {
            const count = currentFilteredTransactions.length;
            document.getElementById('filteredCount').textContent = `${count} 笔`;
            
            // 计算筛选后的统计
            const income = currentFilteredTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const expense = currentFilteredTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            // 更新筛选状态中的统计信息
            const filterStatus = document.getElementById('filterStatus');
            if (filterStatus.style.display !== 'none') {
                const filterStatusText = document.getElementById('filterStatusText');
                const currentText = filterStatusText.textContent || filterStatusText.innerHTML;
                const parts = currentText.split('|');
                if (parts.length > 0) {
                    filterStatusText.innerHTML = `${parts[0]} | 共 <strong>${count}</strong> 笔交易 | 收入 <strong class="text-success">¥${income.toFixed(2)}</strong> | 支出 <strong class="text-danger">¥${expense.toFixed(2)}</strong>`;
                }
            }
        }
        
        // 快速筛选
        function quickFilter() {
            const period = document.getElementById('periodFilter').value;
            
            if (period === 'custom') {
                // 显示自定义日期选择器
                document.getElementById('customDateRangeGroup').style.display = 'block';
                document.getElementById('customDateRangeGroup2').style.display = 'block';
                
                // 设置默认日期（最近30天）
                const today = new Date();
                const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                document.getElementById('startDate').value = monthAgo.toISOString().split('T')[0];
                document.getElementById('endDate').value = today.toISOString().split('T')[0];
            } else {
                // 隐藏自定义日期选择器
                document.getElementById('customDateRangeGroup').style.display = 'none';
                document.getElementById('customDateRangeGroup2').style.display = 'none';
                
                // 应用快速筛选
                applyCustomFilter();
            }
        }
        
        // 应用自定义筛选
        function applyCustomFilter() {
            const period = document.getElementById('periodFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            let filtered = [...allTransactions];
            let filterDesc = [];
            
            // 时间筛选
            const now = new Date();
            switch(period) {
                case 'today':
                    const today = now.toISOString().split('T')[0];
                    filtered = filtered.filter(t => t.date === today);
                    filterDesc.push('今天');
                    break;
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    filtered = filtered.filter(t => new Date(t.date) >= weekAgo);
                    filterDesc.push('最近7天');
                    break;
                case 'month':
                    const monthStr = now.toISOString().substring(0, 7);
                    filtered = filtered.filter(t => t.date && t.date.startsWith(monthStr));
                    filterDesc.push('本月');
                    break;
                case 'custom':
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    
                    if (startDate && endDate) {
                        filtered = filtered.filter(t => {
                            if (!t.date) return false;
                            return t.date >= startDate && t.date <= endDate;
                        });
                        filterDesc.push(`${startDate} ~ ${endDate}`);
                    }
                    break;
            }
            
            // 类型筛选
            if (typeFilter !== 'all') {
                filtered = filtered.filter(t => t.type === typeFilter);
                filterDesc.push(typeFilter === 'income' ? '收入' : '支出');
            }
            
            // 分类筛选
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(t => t.category === categoryFilter);
                filterDesc.push(categoryFilter);
            }
            
            // 更新筛选状态显示
            const filterStatus = document.getElementById('filterStatus');
            const filterStatusText = document.getElementById('filterStatusText');
            
            if (filterDesc.length > 0) {
                filterStatus.style.display = 'block';
                filterStatusText.innerHTML = `<i class="bi bi-funnel-fill"></i> 当前筛选: ${filterDesc.join(' · ')} | 共 <strong>${filtered.length}</strong> 笔交易`;
            } else {
                filterStatus.style.display = 'none';
            }
            
            // 重置到第一页
            currentPage = 1;
            
            // 渲染交易列表和图表
            renderTransactions(filtered);
            
            // 重新初始化图表（确保图表更新）
            if (myChart) {
                myChart.dispose();
                myChart = null;
            }
            initChart(filtered);
            
            console.log('筛选完成，共', filtered.length, '笔交易');
        }
        
        // 重置筛选
        function resetFilters() {
            document.getElementById('periodFilter').value = 'all';
            document.getElementById('typeFilter').value = 'all';
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('customDateRangeGroup').style.display = 'none';
            document.getElementById('customDateRangeGroup2').style.display = 'none';
            document.getElementById('filterStatus').style.display = 'none';
            
            currentPage = 1;
            renderTransactions(allTransactions);
            
            // 重新初始化图表
            if (myChart) {
                myChart.dispose();
                myChart = null;
            }
            initChart(allTransactions);
            
            console.log('筛选已重置');
        }
        
        // 导出为CSV
        function exportToCSV() {
            const period = document.getElementById('periodFilter').value;
            let transactions = getFilteredTransactions();
            
            if (transactions.length === 0) {
                showToast('没有可导出的数据', 'warning');
                return;
            }
            
            // 创建CSV内容
            let csv = '\uFEFF'; // UTF-8 BOM for Excel
            csv += '日期,类型,分类,金额,备注\n';
            
            transactions.forEach(t => {
                const type = t.type === 'income' ? '收入' : '支出';
                const amount = parseFloat(t.amount || 0).toFixed(2);
                const remark = (t.remark || '').replace(/,/g, '，'); // 替换逗号避免CSV错误
                csv += `${t.date},${type},${t.category},${amount},${remark}\n`;
            });
            
            // 下载
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `交易记录_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast(`已导出 ${transactions.length} 笔交易记录`, 'success');
        }
        
        // 导出为JSON
        function exportToJSON() {
            let transactions = getFilteredTransactions();
            
            if (transactions.length === 0) {
                showToast('没有可导出的数据', 'warning');
                return;
            }
            
            const data = {
                export_time: new Date().toISOString(),
                total_count: transactions.length,
                transactions: transactions
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `交易记录_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast(`已导出 ${transactions.length} 笔交易记录`, 'success');
        }
        
        // 获取当前筛选的交易列表
        function getFilteredTransactions() {
            const period = document.getElementById('periodFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            let filtered = [...allTransactions];
            
            // 时间筛选
            const now = new Date();
            switch(period) {
                case 'today':
                    const today = now.toISOString().split('T')[0];
                    filtered = filtered.filter(t => t.date === today);
                    break;
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    filtered = filtered.filter(t => new Date(t.date) >= weekAgo);
                    break;
                case 'month':
                    const monthStr = now.toISOString().substring(0, 7);
                    filtered = filtered.filter(t => t.date && t.date.startsWith(monthStr));
                    break;
                case 'custom':
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    if (startDate && endDate) {
                        filtered = filtered.filter(t => t.date && t.date >= startDate && t.date <= endDate);
                    }
                    break;
            }
            
            if (typeFilter !== 'all') {
                filtered = filtered.filter(t => t.type === typeFilter);
            }
            
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(t => t.category === categoryFilter);
            }
            
            return filtered;
        }
            
        // 初始化图表（趋势线图）
        function initChart(transactions) {
            if (!myChart) {
                const chartDom = document.getElementById('chart-container');
                if (!chartDom) return;
                myChart = echarts.init(chartDom);
            }
            
            // 数据验证和清理
            const validTransactions = transactions.filter(t => 
                t && t.category && t.amount && t.date && t.type
            );
            
            if (validTransactions.length === 0) {
            const option = {
                    title: {
                        text: '暂无数据',
                        left: 'center',
                        top: 'center',
                        textStyle: {
                            color: '#999',
                            fontSize: 16
                        }
                    }
                };
                myChart.setOption(option);
                return;
            }
            
            // 按日期和分类统计
            const dateMap = {};
            const categories = new Set();
            
            validTransactions.forEach(t => {
                const date = t.date;
                const category = t.category || '未分类';
                const amount = parseFloat(t.amount) || 0;
                
                categories.add(category);
                
                if (!dateMap[date]) {
                    dateMap[date] = {};
                }
                if (!dateMap[date][category]) {
                    dateMap[date][category] = 0;
                }
                
                // 累加金额（收入为正，支出也为正，统一显示）
                dateMap[date][category] += amount;
            });
            
            // 获取排序后的日期列表
            const dates = Object.keys(dateMap).sort();
            
            // 按总金额排序分类，取前8个
            const categoriesList = Array.from(categories);
            const categoryTotals = {};
            categoriesList.forEach(cat => {
                categoryTotals[cat] = validTransactions
                    .filter(t => t.category === cat)
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            });
            
            const topCategories = categoriesList
                .sort((a, b) => categoryTotals[b] - categoryTotals[a])
                .slice(0, 8); // 只显示前8个分类
            
            // 准备系列数据
            const series = topCategories.map((category, index) => {
                const data = dates.map(date => {
                    return dateMap[date][category] || 0;
                });
                
                // 颜色方案
                const colors = [
                    '#4cc9f0', '#f72585', '#4361ee', '#3a0ca3',
                    '#7209b7', '#f77f00', '#06d6a0', '#ef476f'
                ];
                
                return {
                    name: category,
                    type: 'line',
                    data: data,
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 6,
                    itemStyle: {
                        color: colors[index % colors.length]
                    },
                    lineStyle: {
                        width: 2
                    },
                    areaStyle: {
                        opacity: 0.1
                    }
                };
            });
            
            const option = {
                title: {
                    text: '分类消费趋势',
                    subtext: `${validTransactions.length}笔交易 | ${dates.length}天 | 前${topCategories.length}个分类`,
                    left: 'center',
                    textStyle: {
                        fontSize: 18,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        label: {
                            backgroundColor: '#6a7985'
                        }
                    },
                    formatter: function(params) {
                        let result = `<strong>${params[0].axisValue}</strong><br>`;
                        let total = 0;
                        
                        params.forEach(p => {
                            if (p.value > 0) {
                                result += `${p.marker} ${p.seriesName}: ¥${p.value.toFixed(2)}<br>`;
                                total += p.value;
                            }
                        });
                        
                        if (params.length > 1) {
                            result += `<strong>当日合计: ¥${total.toFixed(2)}</strong>`;
                        }
                        return result;
                    }
                },
                legend: {
                    data: topCategories,
                    bottom: 5,
                    type: 'scroll',
                    pageButtonItemGap: 5,
                    pageIconSize: 12
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '12%',
                    top: '18%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dates,
                    axisLabel: {
                        rotate: dates.length > 15 ? 45 : 0,
                        interval: Math.max(0, Math.floor(dates.length / 10)),
                        formatter: function(value) {
                            // 格式化日期显示
                            if (value.length === 10) {
                                return value.substring(5); // 显示 MM-DD
                            }
                            return value;
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '金额（¥）',
                    axisLabel: {
                        formatter: function(value) {
                            if (value >= 10000) {
                                return (value / 10000).toFixed(1) + '万';
                            }
                            return value.toFixed(0);
                        }
                    }
                },
                series: series,
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        start: 0,
                        end: 100,
                        height: 20,
                        bottom: 40
                    }
                ]
            };
            
            myChart.setOption(option, true);
            
            // 响应窗口大小变化
            if (window.chartResizeHandler) {
                window.removeEventListener('resize', window.chartResizeHandler);
            }
            window.chartResizeHandler = () => myChart.resize();
            window.addEventListener('resize', window.chartResizeHandler);
            
            console.log('✅ 图表已更新：', topCategories.length, '个分类，', dates.length, '天');
        }
        
        // 确认删除
        let deleteId = null;
        function confirmDelete(id, category, amount) {
            deleteId = id;
            document.getElementById('deleteDetails').innerHTML = `
                <strong>分类:</strong> ${category}<br>
                <strong>金额:</strong> ¥${parseFloat(amount).toFixed(2)}
            `;
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }
        
        // 执行删除
        document.getElementById('confirmDelete').addEventListener('click', async function() {
            if (!deleteId) return;
            
            try {
                const response = await fetch(`/api/transactions/${deleteId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('删除成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                    loadData();
                } else {
                    showToast(data.message || '删除失败', 'danger');
                }
            } catch (error) {
                showToast('删除失败: ' + error.message, 'danger');
            }
        });
        
        // 刷新数据
        function refreshData() {
            showToast('正在刷新数据...', 'info');
            loadData();
        }
        
        // 切换侧边栏（移动端）
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('show');
        }
        
        // 点击主内容区关闭侧边栏
        document.addEventListener('DOMContentLoaded', function() {
            const mainContent = document.querySelector('.main-content');
            const sidebar = document.querySelector('.sidebar');
            
            if (mainContent && sidebar) {
                mainContent.addEventListener('click', function() {
                    if (window.innerWidth <= 768 && sidebar.classList.contains('show')) {
                        sidebar.classList.remove('show');
                    }
                });
            }
        });
    </script>
</body>
</html>
